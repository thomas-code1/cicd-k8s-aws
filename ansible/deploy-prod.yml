---
- name: Deployment of the web app on the k8s cluster
  hosts: controlplane
  become: true
  tasks:
  - name: Creation of folder for application manifests
    file:
      path: /home/{{user}}/app-manifest/production/
      state: directory
      owner: "{{user}}"
      group: "{{group}}"

  - name: Copy of application manifest files to the cluster
    copy:
      src: ../kubernetes/production/
      dest: /home/{{user}}/app-manifest/production/
      owner: "{{user}}" 
      group: "{{group}}"

  - name: replace NFS server IP
    replace:
      path: "/home/{{user}}/app-manifest/production/storage.yml"
      regexp: "nfs_ip_tbc"
      replace: "{{hostvars['nfs'].private_ip}}"
    
  - name: Deploy the application on the k8s cluster
    k8s:
      state: present
      src: "/home/{{user}}/app-manifest/production/{{item}}"
      kubeconfig: /home/{{user}}/.kube/config
    loop:
    - namespace.yml
    - mysql.yml
    - wordpress.yml
    - services.yml
    - storage.yml
    - secret.yml